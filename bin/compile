#!/usr/bin/env bash

set -ve

# If this var is set to true later on,
# then caddy will be rebuilt
caddy_changed=false

build_pack_path=$(cd $(dirname $(dirname $0)); pwd)

# Ensure dirs are present
mkdir -p $1 $2 $3

BUILD_DIR=$(cd $1 && pwd)
CACHE_DIR=$(cd $2 && pwd)
TMP_PATH="$BUILD_DIR/tmp"
BIN_PATH="$BUILD_DIR/bin"

mkdir -p $TMP_PATH

caddy_bin="caddy"

CADDY_URL="https://caddyserver.com/download/build?os=linux&arch=amd64"
CADDY_PKG="$CACHE_DIR/caddy.tar.gz"
CADDY_PATH="$TMP_PATH/caddy"

if [ -f $CADDY_PKG ]; then
  echo "-----> Using wkhtmltopdf Debian package from cache"
else
  echo "-----> Downloading wkhtmltopdf Debian package"
  curl -fsSL "$CADDY_URL" -o "$CADDY_PKG"
fi

echo "-----> Unpacking Debian package"
tar -zxvf "$CADDY_PKG" -C "$CADDY_PATH" "$caddy_bin"
chmod +x "$CADDY_PATH/$caddy_bin"
mv "$CADDY_PATH/$caddy_bin" $BIN_PATH/
rm -rf $CADDY_PATH
